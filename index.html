<!DOCTYPE html>
<head>
	<meta charset="utf-8" />

	<title>Soundstage</title>
	
	<link rel="stylesheet" href="//stephen.band/bolt/css/normalise.css" />
	<link rel="stylesheet" href="//stephen.band/bolt/css/block.css" />
	<link rel="stylesheet" href="//stephen.band/bolt/css/text.css" />
	<link rel="stylesheet" href="//stephen.band/bolt/css/grid.css" />
	<link rel="stylesheet" href="//stephen.band/bolt/css/dom.css" />
	
	<link rel="stylesheet" href="css/soundstage-inspector.css" />
</head>

<body>
	<div class="grid-block block">
		<section class="grid-1/5 block">
			<h3>Plugs</h3>
			<h3>Inputs</h3>
			<h3>Outputs</h3>
		</section
		
		><section class="grid-1/5 block">
			<h3>Sequences</h3>
		</section
		
		><section class="grid-1/5 block">
			<h3>Events</h3>
		</section

		><section class="grid-1/5 block">
		
		</section
		
		><section class="grid-1/5 block">
		
		</section>
	</div>
	
	<script src="polyfills/window.audiocontext.js"></script>
	<script src="polyfills/navigator.getusermedia.js"></script>
	
	<script src="fn/polyfills/number.isnan.js"></script>
	<script src="fn/polyfills/object.assign.js"></script>
	<script src="fn/polyfills/object.setprototypeof.js"></script>
	<script src="fn/js/fn.js"></script>
	<script src="fn/js/stream.js"></script>
	<script src="fn/js/store.js"></script>
	<script src="fn/js/pool.js"></script>
	<script src="fn/js/events.js"></script>
	
	<script src="modules/collection/js/observe.js"></script>
	<script src="modules/collection/js/collection.js"></script>
	<script src="modules/music/music.js"></script>
	
	<script title="config">
		Fn.debug = true;
	</script>
	
	<script src="audio-object/js/audio-object.js"></script>
	<script src="audio-object/js/ao-tick.js"></script>
	<script src="audio-object/js/ao-oscillator.js"></script>
	<script src="audio-object/js/ao-filter.js"></script>
	<script src="audio-object/js/ao-flanger.js"></script>
	<script src="audio-object/js/ao-input.js"></script>
	<script src="audio-object/js/ao-gain.js"></script>
	<script src="audio-object/js/ao-saturate.js"></script>
	<script src="audio-object/js/ao-compress.js"></script>
	<script src="audio-object/js/ao-tone-synth.js"></script>
	<script src="audio-object/js/ao-sampler.js"></script>
	<script src="audio-object/js/ao-sampler-presets-gretsch-kit.js"></script>
	<script src="audio-object/js/ao-sampler-presets-mis-piano.js"></script>
	<script src="audio-object/js/ao-sampler-presets-fender-rhodes-mark-ii.js"></script>
	<script src="audio-object/js/ao-signal-detector.js"></script>
	<script src="audio-object/js/ao-enveloper.js"></script>

	<script src="midi/js/midi.js"></script>
	<script src="midi/js/midi-functions.js"></script>
	<script src="midi/js/midi-setup.js"></script>

	<script src="clock/js/cue-timer.js"></script>
	<script src="clock/js/cue-stream.js"></script>
	<script src="clock/js/clock.js"></script>

	<script src="js/sequence.js"></script>

	<script src="js/soundstage.js"></script>
	<!--script src="js/soundstage.midi.js"></script-->
	<script src="js/soundstage.output.js"></script>
	<script src="js/soundstage.track.js"></script>
	<script src="js/soundstage.send.js"></script>
	<script src="js/soundstage.loop.js"></script>
	
	<script src="modules/dom/js/dom.js"></script>
	<script src="js/soundstage-inspector.js"></script>
	
	<script src="clock/test/data-chromatic.js"></script>
	
	<script>

		var requestTick = Fn.requestTick;

		var stage = Soundstage({
	
			// Version
			//
			// If version is missing, data is assumed to be in the latest format
			"version": 0,

			// Name
			//
			// A string, not required
			"name": "Test",

			// Audio Objects
			//
			// {
			//   "id":     number
			//   "type":   string
			//   "name":   string
			//   "slug":   slug
			//   ...
			// }
	
			"objects": [{
				"id":          0,
				"type":        "oscillator",
				"name":        "Oscillator",
				"slug":        "oscillator",
				"frequency":   200,
				"waveform":    "sine",
				"gain":        0.0625
			}, {
				"id":          1,
				"type":        "sampler",
				"name":        "Piano",
				"slug":        "piano",
				"sample-map":  "MIS Piano",
				"filter-type": "off"
			}, {
				"id":          2,
				"type":        "output",
				"name":        "Out 1-2"
			}, {
				"id":          3,
				"type":        "input",
				"name":        "In 1-2"
			}],

			// Conections
			//
			// {
			//   "src":     id
			//   "dst":     id
			//   "srcName": string
			//   "dstName": string
			// }

			"connections": [
				{ "src": 3, "dst": 2 },
				{ "src": 1, "dst": 2 }
			],

			// MIDI
			//
			// {
			//   "select":    [event]
			//   "transform": [...]
			//   "output":    id || selector
			// }

			"midi": [
				{ "select": [1, "note"], "transform": [], "target": 1 }
			],

			// Sequence
			//
			// {
			//   "id":     number
			//   "name:    string
			//   "slug":   slug
			//   "events": array or functor
			// }
	
			"sequences": [{
				"id":   0,
				"name": "Chromatic",
				"slug": "chromatic",
				"events": (function() {
					var n = -1;
					return Fn(function chromatic() {
						if (++n > 128) { return; }
						return [n / 12, "note", n, 0.5, 1 / 12];
					}).toArray();
				})()
			}, {
				"id":   1,
				"name": "Pedal",
				"slug": "pedal",
				"events": [
					[0, "note", 64, 0.95, 8]
				]
			}, {
				"id":   2,
				"name": "London",
				"slug": "1",
				"events": [
					[0,   "note", 64, 0.4, 0.5],
					[0.5, "note", 64, 0.4, 0.5],
					[1,   "note", 69, 0.6, 1],
					[2,   "note", 69, 0.5, 1],
					[3,   "sequence", '[slug="1"]', '[slug="piano"]'],
				]
			}, {
				"id":   3,
				"name": "London",
				"slug": "2",
				"events": [
					[0,   "note", 71, 0.5, 0.5],
					[0.5, "note", 71, 0.5, 0.5],
					[1,   "note", 73, 0.7, 1],
					[2,   "note", 73, 0.6, 1],
					[3,   "sequence", '[slug="2"]', '[slug="piano"]'],
				]
			}, {
				"id":   4,
				"name": "London",
				"slug": "3",
				"events": [
					[0,   "note", 76, 0.7, 1],
					[1,   "note", 76, 0.7, 2],
					[3,   "sequence", '[slug="3"]', '[slug="piano"]'],
				]
			}, {
				"id":   5,
				"name": "London",
				"slug": "4",
				"events": [
					[0,   "note", 76, 0.7, 0.5],
					[0.5, "note", 74, 0.65, 0.5],
					[1,   "note", 73, 0.6, 1],
					[2,   "note", 73, 0.6, 1],
					[3,   "note", 73, 0.65, 0.5],
					[3.5, "note", 71, 0.55, 0.5],
					[4,   "note", 69, 0.5, 1],
					[5,   "note", 69, 0.5, 1],
					[6,   "sequence", '[slug="4"]', '[slug="piano"]'],
				]
			}],

			// Event types
			//
			// [time, "rate", number, curve]
			// [time, "note", number, velocity, duration]
			// [time, "noteon", number, velocity]
			// [time, "noteoff", number]
			// [time, "param", name, value, curve]
			// [time, "pitch", semitones]
			// [time, "chord", root, mode, duration]
			// [time, "sequence", selector || events, target, duration, transforms...]

			"events": [
				[0, "rate", 2],
				//[0, "sequence", '[id=6]', '[slug="piano"]', 20],
				[0,  "sequence", '[slug="1"]', '[slug="piano"]'],
				//[3,  "sequence", '[slug="1"]', '[slug="piano"]', 3],
				[6,  "sequence", '[slug="2"]', '[slug="piano"]'],
				//[9,  "sequence", '[slug="2"]', '[slug="piano"]', 3],
				[12, "sequence", '[slug="3"]', '[slug="piano"]'],
				//[15, "sequence", '[slug="3"]', '[slug="piano"]', 3],
				[18, "sequence", '[slug="4"]', '[slug="piano"]'],
				//[21, "sequence", '[slug="4"]', '[slug="piano"]', 3],
			]
		});


		// Start
		var audio = stage.audio;

		//stage.start(12);

		var get = Fn.get;
		var is  = Fn.is;

		dom
		.on('keydown', document)
		.map(get('keyCode'))
		.filter(is(32))
		.each(function() {
			var toggle = stage.status === "stopped" ? 'start' : 'stop';
			stage[toggle]();
			if (toggle === 'stop') {
				requestTick(function() { console.table(Pool.snapshot); });
			}
		});

	</script>
</body>
